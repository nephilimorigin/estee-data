<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Dashboard</title>
<script type="module" src="./common.js"></script>

<style>
*{box-sizing:border-box;}
body{
  font-family:Arial;
  padding:20px;
  margin:0;
  background:linear-gradient(135deg,#e1eafe,#f7d9e8,#d9f7f1);
  background-size:300% 300%;
  animation:bgMove 10s ease infinite;
  color:#444;
}
@keyframes bgMove{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
.top-nav{
  display:flex;
  justify-content:space-around;
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(10px);
  padding:12px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
}
.top-nav a{
  text-decoration:none;
  font-weight:600;
  color:#4b3f72;
  font-size:16px;
}
h1{
  text-align:center;
  color:#6a4cff;
  text-shadow:0 0 12px rgba(106,76,255,0.4);
}
.card{
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(10px);
  padding:18px;
  border-radius:20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);
  margin-bottom:22px;
}
.value{
  font-size:19px;
  font-weight:bold;
  margin-top:5px;
}
.miniCard{
  background:white;
  border-radius:14px;
  padding:15px;
  margin-top:12px;
  border:1px solid rgba(0,0,0,0.06);
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
.miniTitle{
  font-size:17px;
  font-weight:bold;
  margin-bottom:8px;
  color:#333;
}
.delete-btn{
  background:#ff4a4a;
  border:none;
  padding:8px 12px;
  color:white;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:rgba(255,255,255,0.78);
  border-radius:12px;
  overflow:hidden;
}
th{
  background:#d7d2fe;
  padding:10px;
}
td{
  padding:10px;
  border-bottom:1px solid #eee;
}

/* âœ… AY SEÃ‡Ä°CÄ° */
.month-bar{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  margin:12px 0 18px 0;
  flex-wrap:wrap;
}
.month-btn{
  border:none;
  cursor:pointer;
  padding:8px 12px;
  border-radius:10px;
  background:rgba(255,255,255,0.8);
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
  font-weight:700;
}
#monthSelect{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.12);
  background:rgba(255,255,255,0.9);
  min-width:180px;
  font-weight:700;
}

/* ğŸ” ÅÄ°FRE EKRANI */
#password-screen{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at top,#1f2937,#020617);
  color:#f9fafb;
  z-index:9999;
}
.password-box{
  background:rgba(15,23,42,0.96);
  padding:30px 26px;
  border-radius:18px;
  width:280px;
  text-align:center;
  box-shadow:0 18px 45px rgba(0,0,0,0.5);
}
#password-input{
  padding:10px;
  width:100%;
  border-radius:10px;
  border:1px solid #4b5563;
  background:#020617;
  color:white;
  text-align:center;
}
.pass-btn{
  margin-top:12px;
  padding:9px 20px;
  background:linear-gradient(135deg,#38bdf8,#818cf8);
  border:none;
  border-radius:999px;
  cursor:pointer;
  font-weight:bold;
}
.hidden{display:none;}
</style>
</head>

<body>

<!-- ğŸ” ÅÄ°FRE -->
<div id="password-screen">
  <div class="password-box">
    <h2>ğŸ”’ GÃ¼venli Dashboard</h2>
    <p>Devam etmek iÃ§in ÅŸifreyi gir.</p>
    <input id="password-input" type="password" />
    <button class="pass-btn" onclick="checkPassword()">GiriÅŸ Yap</button>
    <div id="password-error" style="color:#ff9b9b;margin-top:8px;opacity:0;">HatalÄ± ÅŸifre</div>
  </div>
</div>

<div id="content" class="hidden">

<div class="top-nav">
  <a href="setup.html">ğŸ¯ AyÄ± BaÅŸlat</a>
  <a href="form.html">ğŸ“ GÃ¼nlÃ¼k Veri</a>
  <a href="dashboard.html">ğŸ“Š Dashboard</a>
</div>

<h1>ğŸ“Š AylÄ±k Dashboard</h1>

<!-- âœ… AY SEÃ‡Ä°CÄ° -->
<div class="month-bar">
  <button class="month-btn" id="prevMonth">â—€</button>
  <select id="monthSelect"></select>
  <button class="month-btn" id="nextMonth">â–¶</button>
</div>

<!-- ğŸ”µ CÄ°RO KARTI -->
<div class="card">
  <h2>AylÄ±k Ciro</h2>
  <p class="value">Hedef: <span id="ciroHedef">0</span></p>
  <p class="value">YapÄ±lan: <span id="ciroYapilan">0</span></p>
</div>

<!-- ğŸ”µ HEDEF Ä°LERLEME -->
<div class="card">
  <h2>ğŸ¯ Hedef Ä°lerleme</h2>
  <p class="value">Genel BaÅŸarÄ±: <span id="basariYuzde">0%</span></p>

  <div style="background:#eee;height:10px;border-radius:10px;margin-bottom:10px;">
    <div id="progressBar" style="height:10px;border-radius:10px;background:linear-gradient(90deg,#ff9a9e,#a1c4fd);width:0%;"></div>
  </div>

  <div class="miniCard">
    <div class="miniTitle">%80 Hedefi</div>
    <p>Kalan: <span id="barem80">0</span></p>
    <p>GÃ¼nlÃ¼k: <span id="barem80Gunluk">0</span></p>
  </div>

  <div class="miniCard">
    <div class="miniTitle">%90 Hedefi</div>
    <p>Kalan: <span id="barem90">0</span></p>
    <p>GÃ¼nlÃ¼k: <span id="barem90Gunluk">0</span></p>
  </div>

  <div class="miniCard">
    <div class="miniTitle">%100 Hedefi</div>
    <p>Kalan: <span id="barem100">0</span></p>
    <p>GÃ¼nlÃ¼k: <span id="barem100Gunluk">0</span></p>
  </div>

  <div class="miniCard">
    <div class="miniTitle">%110 Hedefi</div>
    <p>Kalan: <span id="barem110">0</span></p>
    <p>GÃ¼nlÃ¼k: <span id="barem110Gunluk">0</span></p>
  </div>
</div>

<!-- ğŸ”µ GENEL MÃœÅTERÄ° Ã–ZETÄ° -->
<div class="card">
  <h2>ğŸ“¦ Genel MÃ¼ÅŸteri Ã–zeti</h2>
  <div class="miniCard">
    <p>Yeni MÃ¼ÅŸteri: <span id="topYeni">0</span></p>
    <p>SatÄ±n Alan: <span id="topSatin">0</span></p>
    <p>Durdurulan: <span id="topDurdur">0</span></p>
    <p>Davet Edilen: <span id="topDavet">0</span></p>
    <p>Davet â†’ SatÄ±n: <span id="topDavetSatin">0</span></p>
    <p>Toplam Ciro: <span id="topCiro">0</span></p>
  </div>
</div>

<!-- ğŸ”µ FOKUS Ä°LERLEME -->
<div class="card">
  <h2>ğŸ¯ Fokus Ä°lerleme</h2>

  <div class="miniCard">
    <div class="miniTitle">Fokus 1</div>
    <p>GÃ¼nlÃ¼k: <span id="fokus1">0</span></p>
    <p>Hedef: <span id="fokus1Hedef">0</span></p>
    <p>BugÃ¼ne Kadar: <span id="fokus1Yapildi">0</span></p>
    <p>Kalan: <span id="fokus1Kalan">0</span></p>
    <p>% YapÄ±ldÄ±: <span id="fokus1Yuzde">0%</span></p>
  </div>

  <div class="miniCard">
    <div class="miniTitle">Fokus 2</div>
    <p>GÃ¼nlÃ¼k: <span id="fokus2">0</span></p>
    <p>Hedef: <span id="fokus2Hedef">0</span></p>
    <p>BugÃ¼ne Kadar: <span id="fokus2Yapildi">0</span></p>
    <p>Kalan: <span id="fokus2Kalan">0</span></p>
    <p>% YapÄ±ldÄ±: <span id="fokus2Yuzde">0%</span></p>
  </div>

  <div class="miniCard">
    <div class="miniTitle">Fokus 3</div>
    <p>GÃ¼nlÃ¼k: <span id="fokus3">0</span></p>
    <p>Hedef: <span id="fokus3Hedef">0</span></p>
    <p>BugÃ¼ne Kadar: <span id="fokus3Yapildi">0</span></p>
    <p>Kalan: <span id="fokus3Kalan">0</span></p>
    <p>% YapÄ±ldÄ±: <span id="fokus3Yuzde">0%</span></p>
  </div>
</div>

<!-- ğŸ”µ TABLO -->
<h2 style="color:#6a4cff;margin-top:30px;">ğŸ“„ GÃ¼nlÃ¼k KayÄ±tlar</h2>
<table>
<tr>
  <th>Tarih</th>
  <th>Ciro</th>
  <th>Yeni</th>
  <th>SatÄ±n</th>
  <th>Durdur</th>
  <th>Davet</th>
  <th>Davet SatÄ±n</th>
  <th>Not</th>
  <th>Sil</th>
</tr>
<tbody id="dataTable"></tbody>
</table>

</div><!-- CONTENT END -->

<!-- ================ JAVASCRIPT ================ -->
<script type="module">
import { numberToTL, loadMonthlyStats, loadDailyAll, deleteRecord } from "./common.js";

/* âœ… Tarih parse: "DD.MM.YYYY" + "YYYY-MM-DD" destek */
function toISODateString(raw){
  if(!raw) return "";
  const s = String(raw).trim();

  // ISO: 2025-12-07
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // BazÄ± datalar "2025-12-\n07" gibi kÄ±rÄ±labiliyor
  const compact = s.replace(/\s+/g,"");
  if (/^\d{4}-\d{2}-\d{2}$/.test(compact)) return compact;

  // TR: 16.12.2025
  const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if (m){
    const dd = String(m[1]).padStart(2,"0");
    const mm = String(m[2]).padStart(2,"0");
    const yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }

  // Son Ã§are: Date parse (tarayÄ±cÄ±ya baÄŸlÄ±)
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  return "";
}

function monthKeyFromISO(iso){ return iso ? iso.slice(0,7) : ""; } // "YYYY-MM"
function monthLabel(key){
  const [y,m] = key.split("-");
  const months = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
  return `${months[Number(m)-1]} ${y}`;
}

function renderTable(data){
  const tbody=document.getElementById("dataTable");
  tbody.innerHTML="";
  data.forEach(row=>{
    tbody.innerHTML+=`
    <tr>
      <td>${row.tarih}</td>
      <td>${numberToTL(row.ciro)}</td>
      <td>${row.yeni||0}</td>
      <td>${row.satin||0}</td>
      <td>${row.durdurulan||0}</td>
      <td>${row.davet||0}</td>
      <td>${row.davetsatin||0}</td>
      <td>${row.not||""}</td>
      <td><button class="delete-btn" onclick="deleteRow('${row.id}')">Sil</button></td>
    </tr>`;
  });
}

window.deleteRow=async(id)=>{
  if(confirm("Bu kaydÄ± silmek istiyor musun?")){
    await deleteRecord(id);
    location.reload();
  }
};

function sum(arr,key){return arr.reduce((t,x)=>t+Number(x[key]||0),0);}

let ALL_DATA = [];
let SETTINGS = {};
let SELECTED_MONTH = ""; // "YYYY-MM"

function getMonthRange(monthKey){
  const [y,m]=monthKey.split("-").map(Number);
  const start = new Date(y, m-1, 1);
  const end   = new Date(y, m, 1); // sonraki ayÄ±n 1'i
  return { start, end };
}

function isSameMonthAsToday(monthKey){
  const now = new Date();
  const mk = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  return mk === monthKey;
}

function filterBySelectedMonth(data){
  const { start, end } = getMonthRange(SELECTED_MONTH);
  const startISO = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,"0")}-${String(start.getDate()).padStart(2,"0")}`;
  const endISO   = `${end.getFullYear()}-${String(end.getMonth()+1).padStart(2,"0")}-${String(end.getDate()).padStart(2,"0")}`;

  // ISO string compare gÃ¼venli (YYYY-MM-DD)
  return data.filter(x => x._iso >= startISO && x._iso < endISO);
}

function refresh(){
  const monthData = filterBySelectedMonth(ALL_DATA);

  // âœ… Tablo: tarihe gÃ¶re DESC sÄ±ralama
  const tableData = [...monthData].sort((a,b)=> (a._iso < b._iso ? 1 : -1));
  renderTable(tableData);

  /* ğŸ“Œ CÄ°RO */
  const toplamCiro = sum(monthData,"ciro");
  const hedef = Number(SETTINGS.monthlyGoal||0);

  // âœ… SeÃ§ilen aya gÃ¶re gÃ¼n hesabÄ±
  const { start, end } = getMonthRange(SELECTED_MONTH);
  const totalDays = new Date(end.getFullYear(), end.getMonth(), 0).getDate();

  // GÃ¼nlÃ¼k hesap: sadece mevcut ayda "bugÃ¼ne gÃ¶re" mantÄ±klÄ±
  let remainingDays = 1;
  if (isSameMonthAsToday(SELECTED_MONTH)){
    const now = new Date();
    remainingDays = Math.max(1, totalDays - now.getDate() + 1);
  } else {
    // geÃ§miÅŸ/gelecek ay: bÃ¶lme patlamasÄ±n diye 1
    remainingDays = 1;
  }

  const hs={h80:hedef*0.8,h90:hedef*0.9,h100:hedef,h110:hedef*1.1};
  const ks={
    k80:Math.max(0,hs.h80-toplamCiro),
    k90:Math.max(0,hs.h90-toplamCiro),
    k100:Math.max(0,hs.h100-toplamCiro),
    k110:Math.max(0,hs.h110-toplamCiro)
  };

  document.getElementById("ciroHedef").innerText=numberToTL(hedef);
  document.getElementById("ciroYapilan").innerText=numberToTL(toplamCiro);

  document.getElementById("barem80").innerText=numberToTL(ks.k80);
  document.getElementById("barem90").innerText=numberToTL(ks.k90);
  document.getElementById("barem100").innerText=numberToTL(ks.k100);
  document.getElementById("barem110").innerText=numberToTL(ks.k110);

  document.getElementById("barem80Gunluk").innerText=numberToTL(ks.k80/remainingDays);
  document.getElementById("barem90Gunluk").innerText=numberToTL(ks.k90/remainingDays);
  document.getElementById("barem100Gunluk").innerText=numberToTL(ks.k100/remainingDays);
  document.getElementById("barem110Gunluk").innerText=numberToTL(ks.k110/remainingDays);

  const basari = hedef ? (toplamCiro/hedef)*100 : 0;
  document.getElementById("basariYuzde").innerText=basari.toFixed(1)+"%";
  document.getElementById("progressBar").style.width=Math.min(basari,110)+"%";

  /* ğŸ“Œ GENEL MÃœÅTERÄ° */
  document.getElementById("topYeni").innerText = sum(monthData,"yeni");
  document.getElementById("topSatin").innerText = sum(monthData,"satin");
  document.getElementById("topDurdur").innerText = sum(monthData,"durdurulan");
  document.getElementById("topDavet").innerText = sum(monthData,"davet");
  document.getElementById("topDavetSatin").innerText = sum(monthData,"davetsatin");
  document.getElementById("topCiro").innerText = numberToTL(toplamCiro);

  /* ğŸ“Œ FOKUS (seÃ§ilen ayÄ±n kayÄ±tlarÄ± Ã¼zerinden) */
  const f1h=Number(SETTINGS.fokus1Hedef||0);
  const f2h=Number(SETTINGS.fokus2Hedef||0);
  const f3h=Number(SETTINGS.fokus3Hedef||0);

  const f1y = monthData.reduce((t,x)=>t+Number(x.fokus1adet||0),0);
  const f2y = monthData.reduce((t,x)=>t+Number(x.fokus2adet||0),0);
  const f3y = monthData.reduce((t,x)=>t+Number(x.fokus3adet||0),0);

  const f1k = Math.max(0,f1h-f1y);
  const f2k = Math.max(0,f2h-f2y);
  const f3k = Math.max(0,f3h-f3y);

  document.getElementById("fokus1").innerText = Math.ceil(f1k/remainingDays);
  document.getElementById("fokus2").innerText = Math.ceil(f2k/remainingDays);
  document.getElementById("fokus3").innerText = Math.ceil(f3k/remainingDays);

  document.getElementById("fokus1Hedef").innerText=f1h;
  document.getElementById("fokus2Hedef").innerText=f2h;
  document.getElementById("fokus3Hedef").innerText=f3h;

  document.getElementById("fokus1Yapildi").innerText=f1y;
  document.getElementById("fokus2Yapildi").innerText=f2y;
  document.getElementById("fokus3Yapildi").innerText=f3y;

  document.getElementById("fokus1Kalan").innerText=f1k;
  document.getElementById("fokus2Kalan").innerText=f2k;
  document.getElementById("fokus3Kalan").innerText=f3k;

  document.getElementById("fokus1Yuzde").innerText = (f1h? (f1y/f1h)*100:0).toFixed(1)+"%";
  document.getElementById("fokus2Yuzde").innerText = (f2h? (f2y/f2h)*100:0).toFixed(1)+"%";
  document.getElementById("fokus3Yuzde").innerText = (f3h? (f3y/f3h)*100:0).toFixed(1)+"%";
}

function buildMonthSelectFromData(){
  const sel = document.getElementById("monthSelect");
  sel.innerHTML = "";

  // Data iÃ§inden mevcut aylarÄ± Ã§Ä±kar
  const keys = Array.from(new Set(ALL_DATA.map(x=>monthKeyFromISO(x._iso)).filter(Boolean)))
    .sort(); // asc

  // EÄŸer hiÃ§ data yoksa yine de bu ayÄ± gÃ¶ster
  const now = new Date();
  const thisKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  if(!keys.includes(thisKey)) keys.push(thisKey);

  keys.forEach(k=>{
    const opt=document.createElement("option");
    opt.value = k;
    opt.textContent = monthLabel(k);
    sel.appendChild(opt);
  });

  // default: bu ay varsa bu ay, yoksa en son ay
  SELECTED_MONTH = keys.includes(thisKey) ? thisKey : keys[keys.length-1];
  sel.value = SELECTED_MONTH;

  sel.addEventListener("change", ()=>{
    SELECTED_MONTH = sel.value;
    refresh();
  });

  document.getElementById("prevMonth").addEventListener("click", ()=>{
    const idx = keys.indexOf(SELECTED_MONTH);
    if(idx > 0){
      SELECTED_MONTH = keys[idx-1];
      sel.value = SELECTED_MONTH;
      refresh();
    }
  });

  document.getElementById("nextMonth").addEventListener("click", ()=>{
    const idx = keys.indexOf(SELECTED_MONTH);
    if(idx < keys.length-1){
      SELECTED_MONTH = keys[idx+1];
      sel.value = SELECTED_MONTH;
      refresh();
    }
  });
}

async function main(){
  SETTINGS = (await loadMonthlyStats()) || {};
  const raw = await loadDailyAll();

  // âœ… normalize + iso ekle
  ALL_DATA = (raw || []).map(x=>{
    const iso = toISODateString(x.tarih);
    return { ...x, _iso: iso || "" };
  }).filter(x=>x._iso); // iso olmayanÄ± at

  buildMonthSelectFromData();
  refresh();
}
main();
</script>

<!-- PASSWORD -->
<script>
const CORRECT_PASSWORD="EsteeLauder1751!";

function checkPassword(){
  const val=document.getElementById("password-input").value.trim();
  if(val===CORRECT_PASSWORD){
    document.getElementById("password-screen").style.display="none";
    document.getElementById("content").classList.remove("hidden");
  } else {
    document.getElementById("password-error").style.opacity=1;
    setTimeout(()=>{document.getElementById("password-error").style.opacity=0;},1200);
  }
}
</script>

</body>
</html>