<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="./common.js"></script>

<style>
*{box-sizing:border-box;}
body{
  font-family:Arial;
  padding:20px;
  margin:0;
  background:linear-gradient(135deg,#e1eafe,#f7d9e8,#d9f7f1);
  background-size:300% 300%;
  animation:bgMove 10s ease infinite;
  color:#444;
}
@keyframes bgMove{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
.top-nav{
  display:flex;
  justify-content:space-around;
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(10px);
  padding:12px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
}
.top-nav a{
  text-decoration:none;
  font-weight:600;
  color:#4b3f72;
  font-size:16px;
}
h1{
  text-align:center;
  color:#6a4cff;
  text-shadow:0 0 12px rgba(106,76,255,0.4);
}
.card{
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(10px);
  padding:18px;
  border-radius:20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);
  margin-bottom:22px;
}
.value{
  font-size:20px;
  font-weight:bold;
  margin-top:5px;
}
.delete-btn{
  background:#ff4a4a;
  border:none;
  padding:8px 12px;
  color:white;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:rgba(255,255,255,0.75);
  border-radius:12px;
  overflow:hidden;
}
th{
  background:#d7d2fe;
  padding:10px;
}
td{
  padding:10px;
  border-bottom:1px solid #eee;
}

/* üîê ≈ûƒ∞FRE EKRANI */
#password-screen{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at top,#1f2937,#020617);
  color:#f9fafb;
  font-family:Arial, system-ui;
  z-index:9999;
  animation:fadeInBg 0.6s ease-out;
}
.password-box{
  background:rgba(15,23,42,0.96);
  padding:30px 26px;
  border-radius:18px;
  box-shadow:0 18px 45px rgba(0,0,0,0.5);
  text-align:center;
  width:280px;
  max-width:90vw;
  animation:floatUp 0.5s ease-out;
  border:1px solid rgba(148,163,184,0.35);
}
.password-box h2{
  margin:0 0 8px;
  font-size:20px;
}
.password-box p{
  margin:0 0 16px;
  font-size:14px;
  color:#cbd5f5;
}
#password-input{
  padding:10px 12px;
  width:100%;
  border-radius:10px;
  border:1px solid #4b5563;
  outline:none;
  background:#020617;
  color:#f9fafb;
  text-align:center;
  font-size:15px;
}
#password-input:focus{
  border-color:#38bdf8;
  box-shadow:0 0 0 1px rgba(56,189,248,0.7);
}
.pass-btn{
  margin-top:14px;
  padding:10px 22px;
  background:linear-gradient(135deg,#38bdf8,#818cf8);
  color:#020617;
  border:none;
  border-radius:999px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:transform 0.1s ease, box-shadow 0.1s ease;
}
.pass-btn:active{
  transform:scale(0.97);
}
#password-error{
  margin-top:10px;
  font-size:13px;
  color:#fca5a5;
  opacity:0;
  transform:translateY(4px);
  transition:opacity 0.25s, transform 0.25s;
}
#password-screen.fade-out{
  animation:fadeOutBg 0.4s ease-in forwards;
}
.hidden{display:none;}

@keyframes fadeInBg{
  from{opacity:0; transform:scale(1.02);}
  to{opacity:1; transform:scale(1);}
}
@keyframes fadeOutBg{
  from{opacity:1;}
  to{opacity:0; pointer-events:none;}
}
@keyframes floatUp{
  from{opacity:0; transform:translateY(10px);}
  to{opacity:1; transform:translateY(0);}
}
</style>
</head>

<body>

<!-- üîê ≈ûƒ∞FRE EKRANI -->
<div id="password-screen">
  <div class="password-box">
    <h2>üîí G√ºvenli Dashboard</h2>
    <p>Devam etmek i√ßin ≈üifreyi gir.</p>
    <input id="password-input" type="password" placeholder="≈ûifre" autocomplete="off"/>
    <button class="pass-btn" onclick="checkPassword()">Giri≈ü Yap</button>
    <div id="password-error">‚ùå Hatalƒ± ≈üifre</div>
  </div>
</div>
<div id="content" class="hidden">

<div class="top-nav">
  <a href="setup.html">üéØ Ayƒ± Ba≈ülat</a>
  <a href="form.html">üìù G√ºnl√ºk Veri</a>
  <a href="dashboard.html">üìä Dashboard</a>
</div>

<h1>üìä Aylƒ±k Dashboard</h1>

<!-- üîµ Cƒ∞RO -->
<div class="card">
  <h2>Aylƒ±k Ciro Performansƒ±</h2>
  <p class="value">Hedef: <span id="ciroHedef">0</span></p>
  <p class="value">Yapƒ±lan: <span id="ciroYapilan">0</span></p>
  <p class="value">Kalan: <span id="ciroKalan">0</span></p>
  <p class="value">G√ºnl√ºk Gerekli: <span id="ciroGunluk">0</span></p>
  <p class="value">%80 G√ºnl√ºk Gerekli: <span id="ciroGunluk80">0</span></p>
  <p class="value">%90 G√ºnl√ºk Gerekli: <span id="ciroGunluk90">0</span></p>
  <p class="value">%100 G√ºnl√ºk Gerekli: <span id="ciroGunluk100">0</span></p>
  <p class="value">%110 G√ºnl√ºk Gerekli: <span id="ciroGunluk110">0</span></p>
</div>

<!-- üîµ HEDEF -->
<div class="card">
  <h2>üéØ Hedef ƒ∞lerleme</h2>
  <p class="value">Genel Ba≈üarƒ±: <span id="basariYuzde">0%</span></p>
  <div style="background:#eee;height:10px;border-radius:10px;">
    <div id="progressBar"
         style="height:10px;border-radius:10px;background:linear-gradient(90deg,#ff9a9e,#a1c4fd);width:0%;">
    </div>
  </div>
  <p class="value">%80'e kalan: <span id="barem80">0</span></p>
  <p class="value">%90'a kalan: <span id="barem90">0</span></p>
  <p class="value">%100'e kalan: <span id="barem100">0</span></p>
  <p class="value">%110'e kalan: <span id="barem110">0</span></p>
</div>

<!-- üîµ GRAFƒ∞K -->
<div class="card">
  <h2>üìä Y√ºzdelik Grafik</h2>
  <canvas id="yuzdelikChart"></canvas>
</div>

<!-- üîµ FOKUSLAR -->
<div class="card">
  <h2>üéØ Fokus ƒ∞lerleme</h2>

  <p class="value">Fokus 1 G√ºnl√ºk: <span id="fokus1">-</span></p>
  <p class="value">Hedef: <span id="fokus1Hedef">0</span></p>
  <p class="value">Bug√ºne Kadar: <span id="fokus1Yapildi">0</span></p>
  <p class="value">Kalan: <span id="fokus1Kalan">0</span></p>

  <p class="value">Fokus 2 G√ºnl√ºk: <span id="fokus2">-</span></p>
  <p class="value">Hedef: <span id="fokus2Hedef">0</span></p>
  <p class="value">Bug√ºne Kadar: <span id="fokus2Yapildi">0</span></p>
  <p class="value">Kalan: <span id="fokus2Kalan">0</span></p>

  <p class="value">Fokus 3 G√ºnl√ºk: <span id="fokus3">-</span></p>
  <p class="value">Hedef: <span id="fokus3Hedef">0</span></p>
  <p class="value">Bug√ºne Kadar: <span id="fokus3Yapildi">0</span></p>
  <p class="value">Kalan: <span id="fokus3Kalan">0</span></p>
</div>

<!-- üîµ TABLO -->
<h2 style="color:#6a4cff;margin-top:30px;">üìÑ G√ºnl√ºk Kayƒ±tlar</h2>
<table>
<tr>
  <th>Tarih</th>
  <th>Ciro</th>
  <th>Yeni</th>
  <th>Satƒ±n</th>
  <th>Durdur</th>
  <th>Davet</th>
  <th>Davet Satƒ±n</th>
  <th>Not</th>
  <th>Sil</th>
</tr>
<tbody id="dataTable"></tbody>
</table>
</div>


<!-- ========================= -->
<!--      JAVASCRIPT          -->
<!-- ========================= -->

<script type="module">
import { numberToTL, loadMonthlyStats, loadDailyAll, deleteRecord } from "./common.js";

function renderTable(data){
  const tbody=document.getElementById("dataTable");
  tbody.innerHTML="";
  data.forEach(row=>{
    tbody.innerHTML+=`
    <tr>
      <td>${row.tarih}</td>
      <td>${numberToTL(row.ciro)}</td>
      <td>${row.yeni||0}</td>
      <td>${row.satin||0}</td>
      <td>${row.durdurulan||0}</td>
      <td>${row.davet||0}</td>
      <td>${row.davetsatin||0}</td>
      <td>${row.not||""}</td>
      <td><button class="delete-btn" onclick="deleteRow('${row.id}')">Sil</button></td>
    </tr>`;
  });
}

window.deleteRow=async(id)=>{
  if(confirm("Bu kaydƒ± silmek istiyor musun?")){
    await deleteRecord(id);
    location.reload();
  }
};

function sum(arr,key){return arr.reduce((t,x)=>t+Number(x[key]||0),0);}

async function main(){
  const settings=(await loadMonthlyStats())||{};
  const data=await loadDailyAll();
  renderTable(data);

  /* =========================
     üü£ Cƒ∞RO HESAPLARI
     ========================= */
  const toplamCiro=sum(data,"ciro");
  const hedef=Number(settings.monthlyGoal||0);
  const kalan=hedef-toplamCiro;
  const now=new Date();
  const totalDays=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const remainingDays=Math.max(1,totalDays-now.getDate()+1);

  const hedef80=hedef*0.8;
  const hedef90=hedef*0.9;
  const hedef100=hedef;
  const hedef110=hedef*1.1;

  const kalan80=Math.max(0,hedef80-toplamCiro);
  const kalan90=Math.max(0,hedef90-toplamCiro);
  const kalan100=Math.max(0,hedef100-toplamCiro);
  const kalan110=Math.max(0,hedef110-toplamCiro);

  document.getElementById("ciroHedef").innerText=numberToTL(hedef);
  document.getElementById("ciroYapilan").innerText=numberToTL(toplamCiro);
  document.getElementById("ciroKalan").innerText=numberToTL(kalan);
  document.getElementById("ciroGunluk").innerText=numberToTL(kalan/remainingDays);

  document.getElementById("ciroGunluk80").innerText=numberToTL(kalan80/remainingDays);
  document.getElementById("ciroGunluk90").innerText=numberToTL(kalan90/remainingDays);
  document.getElementById("ciroGunluk100").innerText=numberToTL(kalan100/remainingDays);
  document.getElementById("ciroGunluk110").innerText=numberToTL(kalan110/remainingDays);

  document.getElementById("barem80").innerText=numberToTL(kalan80);
  document.getElementById("barem90").innerText=numberToTL(kalan90);
  document.getElementById("barem100").innerText=numberToTL(kalan100);
  document.getElementById("barem110").innerText=numberToTL(kalan110);

  const basari=(hedef===0?0:(toplamCiro/hedef)*100);
  document.getElementById("basariYuzde").innerText=basari.toFixed(1)+"%";
  document.getElementById("progressBar").style.width=Math.min(basari,110)+"%";

  /* =========================
     üü£ FOKUS DOƒûRU HESAPLAMA
     ========================= */

  const fokus1Hedef = Number(settings.fokus1Hedef || 0);
  const fokus2Hedef = Number(settings.fokus2Hedef || 0);
  const fokus3Hedef = Number(settings.fokus3Hedef || 0);

  const bugun = new Date().toISOString().split("T")[0];
  const firstDay = new Date();
  firstDay.setDate(1);
  const firstDayString = firstDay.toISOString().split("T")[0];

  const monthRecords = data.filter(x => x.tarih >= firstDayString && x.tarih <= bugun);

  const fokus1YapildiToplam = monthRecords.reduce((t,x)=>t+Number(x.fokus1adet||0),0);
  const fokus2YapildiToplam = monthRecords.reduce((t,x)=>t+Number(x.fokus2adet||0),0);
  const fokus3YapildiToplam = monthRecords.reduce((t,x)=>t+Number(x.fokus3adet||0),0);

  const fokus1Kalan = Math.max(0, fokus1Hedef - fokus1YapildiToplam);
  const fokus2Kalan = Math.max(0, fokus2Hedef - fokus2YapildiToplam);
  const fokus3Kalan = Math.max(0, fokus3Hedef - fokus3YapildiToplam);

  const fokus1Bugun = Math.ceil(fokus1Kalan / remainingDays);
  const fokus2Bugun = Math.ceil(fokus2Kalan / remainingDays);
  const fokus3Bugun = Math.ceil(fokus3Kalan / remainingDays);

  document.getElementById("fokus1").innerText=fokus1Bugun;
  document.getElementById("fokus2").innerText=fokus2Bugun;
  document.getElementById("fokus3").innerText=fokus3Bugun;

  document.getElementById("fokus1Hedef").innerText=fokus1Hedef;
  document.getElementById("fokus2Hedef").innerText=fokus2Hedef;
  document.getElementById("fokus3Hedef").innerText=fokus3Hedef;

  document.getElementById("fokus1Yapildi").innerText=fokus1YapildiToplam;
  document.getElementById("fokus2Yapildi").innerText=fokus2YapildiToplam;
  document.getElementById("fokus3Yapildi").innerText=fokus3YapildiToplam;

  document.getElementById("fokus1Kalan").innerText=fokus1Kalan;
  document.getElementById("fokus2Kalan").innerText=fokus2Kalan;
  document.getElementById("fokus3Kalan").innerText=fokus3Kalan;

}
main();
</script>

<!-- üîê ≈ûƒ∞FRE Sƒ∞STEMƒ∞ -->
<script>
const CORRECT_PASSWORD = "EsteeLauder1751!";

function showError() {
  const err=document.getElementById("password-error");
  err.style.opacity=1;
  err.style.transform="translateY(0)";
  setTimeout(()=>{
    err.style.opacity=0;
    err.style.transform="translateY(4px)";
  },1500);
}

function checkPassword(){
  const val=document.getElementById("password-input").value.trim();
  if(val===CORRECT_PASSWORD){
    document.getElementById("password-screen").classList.add("fade-out");
    setTimeout(()=>{
      document.getElementById("password-screen").style.display="none";
      document.getElementById("content").classList.remove("hidden");
    },350);
  } else {
    showError();
  }
}

window.addEventListener("DOMContentLoaded",()=>{
  const input=document.getElementById("password-input");
  input.focus();
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter") checkPassword();
  });
});
</script>

</body>
</html>