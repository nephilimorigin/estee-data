<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial;
      padding: 20px;
      margin: 0;
      background: linear-gradient(135deg, #e1eafe, #f7d9e8, #d9f7f1);
      background-size: 300% 300%;
      animation: bgMove 10s ease infinite;
      color: #444;
    }

    @keyframes bgMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .top-nav {
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      padding: 12px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .top-nav a {
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      color: #4b3f72;
    }

    h1 {
      text-align: center;
      color: #6a4cff;
      font-size: 30px;
      text-shadow: 0 0 12px rgba(106,76,255,0.4);
      margin-bottom: 25px;
    }

    .card {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      padding: 18px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 22px;
    }

    .card h2 {
      margin: 0;
      font-size: 20px;
      font-weight: bold;
      color: #6a4cff;
    }

    .value {
      font-size: 22px;
      margin-top: 6px;
      font-weight: bold;
      color: #333;
    }

    .progress-wrap {
      width: 100%;
      background: #eee;
      height: 22px;
      border-radius: 14px;
      overflow: hidden;
      margin: 12px 0 15px 0;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #b395ff, #ff9ce8, #a0e9ff);
      transition: width .6s ease;
      border-radius: 14px;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: rgba(255,255,255,0.75);
      border-radius: 12px;
      overflow: hidden;
    }

    th {
      background: #d7d2fe;
      padding: 10px;
      color: #4a3cd1;
      font-size: 16px;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
  </style>
</head>

<body>

<div class="top-nav">
  <a href="setup.html">ğŸ¯ AyÄ± BaÅŸlat</a>
  <a href="form.html">ğŸ“ GÃ¼nlÃ¼k Veri</a>
  <a href="dashboard.html">ğŸ“Š Dashboard</a>
</div>

<h1>ğŸ“Š AylÄ±k Dashboard</h1>

<div class="card">
  <h2>AylÄ±k Ciro PerformansÄ±</h2>
  <p class="value">Hedef: <span id="ciroHedef">0</span> TL</p>
  <p class="value">YapÄ±lan: <span id="ciroYapilan">0</span> TL</p>
  <p class="value">Kalan: <span id="ciroKalan">0</span> TL</p>
  <p class="value">GÃ¼nlÃ¼k Gerekli: <span id="ciroGunluk">0</span> TL</p>
</div>

<div class="card">
  <h2>ğŸ¯ Hedef Ä°lerleme</h2>
  <p class="value">Genel BaÅŸarÄ±: <span id="basariYuzde">0%</span></p>
  <div class="progress-wrap">
    <div id="progressBar" class="progress-bar"></div>
  </div>
  <p class="value">%80'e kalan: <span id="barem80">0</span> TL</p>
  <p class="value">%90'a kalan: <span id="barem90">0</span> TL</p>
  <p class="value">%100'e kalan: <span id="barem100">0</span> TL</p>
  <p class="value">%110'a kalan: <span id="barem110">0</span> TL</p>
</div>

<div id="fokusContainer"></div>

<div class="card">
  <h2>MÃ¼ÅŸteri AnalitiÄŸi</h2>
  <p class="value">Yeni MÃ¼ÅŸteri: <span id="yeniTop">0</span></p>
  <p class="value">SatÄ±n Alan: <span id="satinTop">0</span></p>
  <p class="value">SatÄ±n Alma OranÄ±: <span id="cr">0%</span></p>
  <p class="value">Durdurulan: <span id="durdurTop">0</span></p>
  <p class="value">Durdurma BaÅŸarÄ±sÄ±: <span id="ssr">0%</span></p>
  <p class="value">Davet Edilen: <span id="davetTop">0</span></p>
  <p class="value">Davet â†’ SatÄ±ÅŸ Alan: <span id="davetsatinTop">0</span></p>
  <p class="value">Davet BaÅŸarÄ±sÄ±: <span id="icr">0%</span></p>
</div>

<div class="card">
  <h2>GÃ¼nlÃ¼k Ciro GrafiÄŸi</h2>
  <canvas id="ciroChart"></canvas>
</div>

<div class="card">
  <h2>Fokus ÃœrÃ¼n Grafikleri</h2>
  <canvas id="fokusChart"></canvas>
</div>

<h2 style="margin-top:35px;color:#6a4cff;">ğŸ“„ GÃ¼nlÃ¼k KayÄ±tlar</h2>

<table>
  <tr>
    <th>Tarih</th>
    <th>Ciro</th>
    <th>Fokus1</th>
    <th>Fokus2</th>
    <th>Fokus3</th>
    <th>Not</th>
  </tr>
  <tbody id="dataTable"></tbody>
</table>

<script type="module">
  import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";

  import { getFirestore, collection, getDocs, query, orderBy, limit }
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgh7QT9ORiww11m78X0GxaoPaU_kGB07E",
    authDomain: "estee-lauder-app.firebaseapp.com",
    projectId: "estee-lauder-app",
    storageBucket: "estee-lauder-app.firebasestorage.app",
    messagingSenderId: "585743636422",
    appId: "1:585743636422:web:cb7094f89a04ad6deb84c7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let settings = null;

  async function loadSettings() {
    const q = query(collection(db, "settings"), orderBy("createdAt", "desc"), limit(1));
    const snap = await getDocs(q);
    snap.forEach(doc => settings = doc.data());

    if (settings) {
      document.getElementById("ciroHedef").innerText = settings.ciroHedef;
    }
    return settings;
  }

  async function loadDaily() {
    const snap = await getDocs(collection(db, "daily"));
    let data = [];
    snap.forEach(doc => data.push(doc.data()));
    return data;
  }

  function sum(arr, key) {
    return arr.reduce((t, x) => t + Number(x[key] || 0), 0);
  }

  function fillTable(data) {
    const tbody = document.getElementById("dataTable");
    tbody.innerHTML = "";
    data.forEach(x => {
      tbody.innerHTML += `
        <tr>
          <td>${x.tarih}</td>
          <td>${x.ciro}</td>
          <td>${x.fokus1}</td>
          <td>${x.fokus2}</td>
          <td>${x.fokus3}</td>
          <td>${x.not || ""}</td>
        </tr>
      `;
    });
  }

  function fokusCard(ad, hedef, satilan) {
    let kalan = hedef - satilan;
    let gunlukGerek = kalan / 30;

    return `
      <div class="card">
        <h2>${ad}</h2>
        <p class="value">Hedef: ${hedef}</p>
        <p class="value">SatÄ±lan: ${satilan}</p>
        <p class="value">Kalan: ${kalan}</p>
        <p class="value">GÃ¼nlÃ¼k Gerekli: ${gunlukGerek.toFixed(1)}</p>
      </div>
    `;
  }

  async function main() {
    await loadSettings();
    let data = await loadDaily();

    fillTable(data);

    let toplamCiro = sum(data, "ciro");
    let kalanCiro = (settings?.ciroHedef || 0) - toplamCiro;
    let gunlukGerek = kalanCiro / 30;

    document.getElementById("ciroYapilan").innerText = toplamCiro;
    document.getElementById("ciroKalan").innerText = kalanCiro;
    document.getElementById("ciroGunluk").innerText = gunlukGerek.toFixed(1);

    let hedef = settings.ciroHedef;
    let yapilan = toplamCiro;
    let basari = (yapilan / hedef) * 100;
    document.getElementById("basariYuzde").innerText = basari.toFixed(1) + "%";
    document.getElementById("progressBar").style.width = Math.min(basari, 110) + "%";

    let barem80 = hedef * 0.80;
    let barem90 = hedef * 0.90;
    let barem100 = hedef * 1.00;
    let barem110 = hedef * 1.10;

    document.getElementById("barem80").innerText = Math.max(0, barem80 - yapilan).toFixed(0);
    document.getElementById("barem90").innerText = Math.max(0, barem90 - yapilan).toFixed(0);
    document.getElementById("barem100").innerText = Math.max(0, barem100 - yapilan).toFixed(0);
    document.getElementById("barem110").innerText = Math.max(0, barem110 - yapilan).toFixed(0);

    let fokus1Top = sum(data, "fokus1");
    let fokus2Top = sum(data, "fokus2");
    let fokus3Top = sum(data, "fokus3");

    document.getElementById("fokusContainer").innerHTML =
      fokusCard(settings.fokus1_ad, settings.fokus1_hedef, fokus1Top) +
      fokusCard(settings.fokus2_ad, settings.fokus2_hedef, fokus2Top) +
      fokusCard(settings.fokus3_ad, settings.fokus3_hedef, fokus3Top);

    let yeniTop = sum(data, "yeni");
    let satinTop = sum(data, "satin");
    let durdurTop = sum(data, "durdurulan");
    let davetTop = sum(data, "davet");
    let davetsatinTop = sum(data, "davetsatin");

    document.getElementById("yeniTop").innerText = yeniTop;
    document.getElementById("satinTop").innerText = satinTop;
    document.getElementById("durdurTop").innerText = durdurTop;
    document.getElementById("davetTop").innerText = davetTop;
    document.getElementById("davetsatinTop").innerText = davetsatinTop;

    let cr = (satinTop / yeniTop) * 100 || 0;
    let ssr = (satinTop / durdurTop) * 100 || 0;
    let icr = (davetsatinTop / davetTop) * 100 || 0;

    document.getElementById("cr").innerText = cr.toFixed(1) + "%";
    document.getElementById("ssr").innerText = ssr.toFixed(1) + "%";
    document.getElementById("icr").innerText = icr.toFixed(1) + "%";

    new Chart(document.getElementById("ciroChart"), {
      type: 'line',
      data: {
        labels: data.map(x => x.tarih),
        datasets: [{
          label: "GÃ¼nlÃ¼k Ciro",
          data: data.map(x => x.ciro),
          borderColor: "#6a4cff",
          borderWidth: 3
        }]
      }
    });

    new Chart(document.getElementById("fokusChart"), {
      type: 'line',
      data: {
        labels: data.map(x => x.tarih),
        datasets: [
          { label: settings.fokus1_ad, data: data.map(x => x.fokus1), borderColor: "#ff7edb" },
          { label: settings.fokus2_ad, data: data.map(x => x.fokus2), borderColor: "#7edfff" },
          { label: settings.fokus3_ad, data: data.map(x => x.fokus3), borderColor: "#ffce7e" }
        ]
      }
    });

  }

  main();


// =====================
// EXCEL / CSV EXPORT
// =====================

document.getElementById("exportBtn").addEventListener("click", async () => {
    const data = [];

    // ğŸ”¥ DÃœZELTÄ°LEN KOLEKSÄ°YON ADI: daily
    const querySnapshot = await getDocs(collection(db, "daily"));
    querySnapshot.forEach((doc) => {
        data.push(doc.data());
    });

    if (data.length === 0) {
        alert("HiÃ§ veri yok!");
        return;
    }

    const csv = convertToCSV(data);

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "estee-data.csv";
    a.click();
});

function convertToCSV(data) {
    const headers = Object.keys(data[0]);
    let csv = headers.join(",") + "\n";

    data.forEach(row => {
        const values = headers.map(h => row[h]);
        csv += values.join(",") + "\n";
    });

    return csv;
}
</script>

<button id="exportBtn" style="margin: 20px; padding:10px 15px;">
    Verileri Excel Olarak Ä°ndir
</button>

</body>
</html>